/*
   This program is free software; you can redistribute it and/or modify
   it under the terms of the GNU General Public License as published by
   the Free Software Foundation; either version 2 of the License, or
   (at your option) any later version.

   This program is distributed in the hope that it will be useful,
   but WITHOUT ANY WARRANTY; without even the implied warranty of
   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
   GNU General Public License for more details.

   You should have received a copy of the GNU General Public License
   along with this program; if not, write to the Free Software
   Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.

   Product name: redemption, a FLOSS RDP proxy
   Copyright (C) Wallix 2011-2013
   Author(s): Christophe Grosjean, Martin Potier

   Unit test of Drawing primitive used to create snapshot/movies
   Using lib boost functions for testing
*/


#define BOOST_AUTO_TEST_MAIN
#define BOOST_TEST_DYN_LINK
#define BOOST_TEST_MODULE TestCapture
#include <boost/test/auto_unit_test.hpp>

#define LOGNULL
//#define LOGPRINT
#include "log.hpp"

#include <errno.h>
#include <algorithm>

#include "ssl_calls.hpp"
#include "png.hpp"
#include "RDP/RDPDrawable.hpp"
#include "staticcapture.hpp"
#include "drawable.hpp"
#include "rdtsc.hpp"

inline bool check_sig(const uint8_t* data, std::size_t height, uint32_t len,
                      char * message, const char * shasig)
{
    uint8_t sig[20];
    SslSha1 sha1;
    for (size_t y = 0; y < static_cast<size_t>(height); y++){
        sha1.update(data + y * len, len);
    }
    sha1.final(sig, 20);

    if (memcmp(shasig, sig, 20)){
        sprintf(message, "Expected signature: \""
        "\\x%.2x\\x%.2x\\x%.2x\\x%.2x"
        "\\x%.2x\\x%.2x\\x%.2x\\x%.2x"
        "\\x%.2x\\x%.2x\\x%.2x\\x%.2x"
        "\\x%.2x\\x%.2x\\x%.2x\\x%.2x"
        "\\x%.2x\\x%.2x\\x%.2x\\x%.2x\"",
        sig[ 0], sig[ 1], sig[ 2], sig[ 3],
        sig[ 4], sig[ 5], sig[ 6], sig[ 7],
        sig[ 8], sig[ 9], sig[10], sig[11],
        sig[12], sig[13], sig[14], sig[15],
        sig[16], sig[17], sig[18], sig[19]);
        return false;
    }
    return true;
}

inline bool check_sig(Drawable & data, char * message, const char * shasig)
{
    return check_sig(data.data, data.height, data.rowsize, message, shasig);
}

// to see last result file, remove unlink
// and do something like:
// eog `ls -1tr /tmp/test_* | tail -n 1`
// (or any other variation you like)

void dump_png(const char * prefix, const Drawable & data)
{
    char tmpname[128];
    sprintf(tmpname, "%sXXXXXX.png", prefix);
    int fd = ::mkostemps(tmpname, 4, O_WRONLY|O_CREAT);
    FILE * f = fdopen(fd, "wb");
    ::dump_png24(f, data.data, data.width, data.height, data.rowsize, true);
    ::fclose(f);
}

void save_to_png(const char * filename, const Drawable & data)
{
    FILE * file = fopen(filename, "w+");
    dump_png24(file, data.data, data.width,
               data.height, data.rowsize, true);
    fclose(file);
}

BOOST_AUTO_TEST_CASE(TestLineTo)
{
    // Create a simple capture image and dump it to file
    uint16_t width = 640;
    uint16_t height = 480;
    Rect screen_rect(0, 0, width, height);
    RDPDrawable gd(width, height, 24);
    gd.draw(RDPOpaqueRect(screen_rect, WHITE), screen_rect);
    gd.draw(RDPOpaqueRect(screen_rect.shrink(5), BLACK), screen_rect);

    uint16_t y = screen_rect.cy - 1;
    for (uint16_t x = 0 ; x < screen_rect.cx ; x += 40){
        gd.draw(RDPLineTo(0, 0, 0, x, y, BLUE, 0xCC, RDPPen(0, 1, GREEN)), screen_rect);
        gd.draw(RDPLineTo(0, x + 10, y, 0, 0, BLUE, 0xCC, RDPPen(0, 1, RED)), screen_rect);
        gd.draw(RDPLineTo(0, screen_rect.cx - 1, 0, screen_rect.cx - 1 - x, y, BLUE, 0xCC, RDPPen(0, 1, WHITE)), screen_rect);
        gd.draw(RDPLineTo(0, screen_rect.cx - 1 - x + 10, y, screen_rect.cx - 1, 0, BLUE, 0xCC, RDPPen(0, 1, BLUE)), screen_rect);
    }
    gd.draw(RDPLineTo(0, 0, 0, 640, 480, BLUE, 0xCC, RDPPen(0, 1, GREEN)), screen_rect);

    gd.draw(RDPLineTo(0, 0, 0, 1024, 0, BLUE, 0xCC, RDPPen(0, 1, PINK)), screen_rect);
    gd.draw(RDPLineTo(0, 0, 0, 0, 768, BLUE, 0xCC, RDPPen(0, 1, PINK)), screen_rect);
    gd.draw(RDPLineTo(0, 639, 0, 639, 768, BLUE, 0xCC, RDPPen(0, 1, PINK)), screen_rect);
    gd.draw(RDPLineTo(0, 0, 479, 1024, 479, BLUE, 0xCC, RDPPen(0, 1, PINK)), screen_rect);

    gd.draw(RDPLineTo(10, 0, 10, 1024, 479, BLUE, 0xCC, RDPPen(0, 1, PINK)), screen_rect.shrink(5));

    char message[1024];
    if (!check_sig(gd.drawable, message,
                   "\xba\x61\xe0\xa7\x5a\x4d\xc0\xf1\xfd\xaf"
                   "\x57\x73\x04\x9f\xc9\xb5\xd4\xba\x75\x6a"
                   )){
        BOOST_CHECK_MESSAGE(false, message);
    }

    // uncomment to see result in png file
    //save_to_png("/tmp/test_line_000.png", gd.drawable);
    //dump_png("/tmp/test_line_005_", gd.drawable);
}

BOOST_AUTO_TEST_CASE(TestPolyline)
{
    // Create a simple capture image and dump it to file
    uint16_t width = 640;
    uint16_t height = 480;
    Rect screen_rect(0, 0, width, height);
    RDPDrawable gd(width, height, 24);
    gd.draw(RDPOpaqueRect(screen_rect, WHITE), screen_rect);
    gd.draw(RDPOpaqueRect(screen_rect.shrink(5), BLACK), screen_rect);

    Array array(1024);
    OutStream deltaPoints(array);

    deltaPoints.out_sint16_le(0);
    deltaPoints.out_sint16_le(20);

    deltaPoints.out_sint16_le(160);
    deltaPoints.out_sint16_le(0);

    deltaPoints.out_sint16_le(0);
    deltaPoints.out_sint16_le(-30);

    deltaPoints.out_sint16_le(50);
    deltaPoints.out_sint16_le(50);

    deltaPoints.out_sint16_le(-50);
    deltaPoints.out_sint16_le(50);

    deltaPoints.out_sint16_le(0);
    deltaPoints.out_sint16_le(-30);

    deltaPoints.out_sint16_le(-160);
    deltaPoints.out_sint16_le(0);

    deltaPoints.mark_end();

    SubStreamArray dp(array, 0, deltaPoints.size());

    gd.draw(RDPPolyline(158, 230, 0x06, 0, 0xFFFFFF, 7, dp), screen_rect);

    char message[1024];
    if (!check_sig(gd.drawable, message,
    "\x32\x60\x8b\x02\xb9\xa2\x83\x27\x0f\xa9\x67\xef\x3c\x2e\xa0\x25\x69\x16\x02\x2b"
    )){
        BOOST_CHECK_MESSAGE(false, message);
    }

    // uncomment to see result in png file
    //dump_png("/tmp/test_polyline_000_", gd.drawable);
}

BOOST_AUTO_TEST_CASE(TestMultiDstBlt)
{
    // Create a simple capture image and dump it to file
    uint16_t width = 640;
    uint16_t height = 480;
    Rect screen_rect(0, 0, width, height);
    RDPDrawable gd(width, height, 24);
    gd.draw(RDPOpaqueRect(screen_rect, WHITE), screen_rect);
    gd.draw(RDPOpaqueRect(screen_rect.shrink(5), GREEN), screen_rect);

    BStream deltaRectangles(1024);

    deltaRectangles.out_sint16_le(100);
    deltaRectangles.out_sint16_le(100);
    deltaRectangles.out_sint16_le(10);
    deltaRectangles.out_sint16_le(10);

    for (int i = 0; i < 19; i++) {
        deltaRectangles.out_sint16_le(10);
        deltaRectangles.out_sint16_le(10);
        deltaRectangles.out_sint16_le(10);
        deltaRectangles.out_sint16_le(10);
    }

    deltaRectangles.mark_end();
    deltaRectangles.rewind();

    gd.draw(RDPMultiDstBlt(100, 100, 200, 200, 0x55, 20, deltaRectangles), screen_rect);

    char message[1024];
    if (!check_sig(gd.drawable, message,
    "\x3d\x83\xd7\x7e\x0b\x3e\xf4\xd1\x53\x50\x33\x94\x1e\x11\x46\x9c\x60\x76\xd7\x0a"
    )){
        BOOST_CHECK_MESSAGE(false, message);
    }

    // uncomment to see result in png file
    //dump_png("/tmp/test_multidstblt_000_", gd.drawable);
}

BOOST_AUTO_TEST_CASE(TestMultiOpaqueRect)
{
    // Create a simple capture image and dump it to file
    uint16_t width = 640;
    uint16_t height = 480;
    Rect screen_rect(0, 0, width, height);
    RDPDrawable gd(width, height, 24);
    gd.draw(RDPOpaqueRect(screen_rect, WHITE), screen_rect);
    gd.draw(RDPOpaqueRect(screen_rect.shrink(5), GREEN), screen_rect);

    BStream deltaRectangles(1024);

    deltaRectangles.out_sint16_le(100);
    deltaRectangles.out_sint16_le(100);
    deltaRectangles.out_sint16_le(10);
    deltaRectangles.out_sint16_le(10);

    for (int i = 0; i < 19; i++) {
        deltaRectangles.out_sint16_le(10);
        deltaRectangles.out_sint16_le(10);
        deltaRectangles.out_sint16_le(10);
        deltaRectangles.out_sint16_le(10);
    }

    deltaRectangles.mark_end();
    deltaRectangles.rewind();

    gd.draw(RDPMultiOpaqueRect(100, 100, 200, 200, 0x000000, 20, deltaRectangles), screen_rect);

    char message[1024];
    if (!check_sig(gd.drawable, message,
    "\x1d\x52\x8e\x03\x43\xc8\x99\x8d\xeb\x51\xa6\x23\x91\x24\xab\x8c\xa4\xcc\xf0\xc8"
    )){
        BOOST_CHECK_MESSAGE(false, message);
    }

    // uncomment to see result in png file
    //dump_png("/tmp/test_multiopaquerect_000_", gd.drawable);
}

BOOST_AUTO_TEST_CASE(TestEllipse)
{
    uint16_t width = 1280;
    uint16_t height = 1024;
    Rect screen_rect(0, 0, width, height);
    RDPDrawable gd(width, height, 24);
    gd.draw(RDPOpaqueRect(screen_rect, WHITE), screen_rect);
    gd.draw(RDPOpaqueRect(screen_rect.shrink(5), LIGHT_GREEN), screen_rect);

    uint64_t usec = ustime();
    uint64_t cycles = rdtsc();

    gd.draw(RDPEllipseSC(Rect(2, 200, 540, 32), BLUE, 0x06, 0x01), screen_rect);

    uint64_t elapusec = ustime() - usec;
    uint64_t elapcyc = rdtsc() - cycles;
    LOG(LOG_INFO, "elapsed time = %llu %llu %f\n", elapusec, elapcyc, (double)elapcyc / (double)elapusec);

    usec = ustime();
    cycles = rdtsc();

    gd.draw(RDPEllipseSC(Rect(100, 2, 40, 400), RED, 0x06, 0x01), screen_rect);

    elapusec = ustime() - usec;
    elapcyc = rdtsc() - cycles;
    LOG(LOG_INFO, "elapsed time = %llu %llu %f\n", elapusec, elapcyc, (double)elapcyc / (double)elapusec);

    usec = ustime();
    cycles = rdtsc();

    gd.draw(RDPEllipseSC(Rect(2, 300, 540, 32), BLUE, 0x06, 0x00), screen_rect);
    gd.draw(RDPEllipseSC(Rect(200, 2, 40, 400), RED, 0x06, 0x00), screen_rect);

    gd.draw(RDPEllipseSC(Rect(2, 600, 540, 32), BLUE, 0x0D, 0x00), screen_rect);
    gd.draw(RDPEllipseSC(Rect(200, 500, 40, 401), RED, 0x0D, 0x00), screen_rect);

    gd.draw(RDPEllipseSC(Rect(2, 610, 540, 32), BLUE, 0x0D, 0x01), screen_rect);
    gd.draw(RDPEllipseSC(Rect(300, 500, 40, 401), RED, 0x0D, 0x01), screen_rect);



    gd.draw(RDPEllipseSC(Rect(700, 12, 6, 6), BLUE, 0x0D, 0x00), screen_rect);
    gd.draw(RDPEllipseSC(Rect(715, 12, 6, 6), BLUE, 0x0D, 0x01), screen_rect);
    gd.draw(RDPEllipseSC(Rect(730, 12, 6, 6), BLUE, 0x06, 0x00), screen_rect);
    gd.draw(RDPEllipseSC(Rect(745, 12, 6, 6), BLUE, 0x06, 0x01), screen_rect);

    gd.draw(RDPEllipseSC(Rect(700, 28, 5, 5), GREEN, 0x0D, 0x00), screen_rect);
    gd.draw(RDPEllipseSC(Rect(715, 28, 5, 5), GREEN, 0x0D, 0x01), screen_rect);
    gd.draw(RDPEllipseSC(Rect(730, 28, 5, 5), GREEN, 0x06, 0x00), screen_rect);
    gd.draw(RDPEllipseSC(Rect(745, 28, 5, 5), GREEN, 0x06, 0x01), screen_rect);

    gd.draw(RDPEllipseSC(Rect(800, 12, 8, 8), BLUE, 0x0D, 0x00), screen_rect);
    gd.draw(RDPEllipseSC(Rect(815, 12, 8, 8), BLUE, 0x0D, 0x01), screen_rect);
    gd.draw(RDPEllipseSC(Rect(830, 12, 8, 8), BLUE, 0x06, 0x00), screen_rect);
    gd.draw(RDPEllipseSC(Rect(845, 12, 8, 8), BLUE, 0x06, 0x01), screen_rect);

    gd.draw(RDPEllipseSC(Rect(800, 38, 15, 15), GREEN, 0x0D, 0x00), screen_rect);
    gd.draw(RDPEllipseSC(Rect(815, 38, 15, 15), GREEN, 0x0D, 0x01), screen_rect);
    gd.draw(RDPEllipseSC(Rect(830, 38, 15, 15), GREEN, 0x06, 0x00), screen_rect);
    gd.draw(RDPEllipseSC(Rect(845, 38, 15, 15), GREEN, 0x06, 0x01), screen_rect);

    gd.draw(RDPEllipseSC(Rect(800, 88, 5, 15), GREEN, 0x0D, 0x00), screen_rect);
    gd.draw(RDPEllipseSC(Rect(815, 88, 5, 15), GREEN, 0x0D, 0x01), screen_rect);
    gd.draw(RDPEllipseSC(Rect(830, 88, 5, 15), GREEN, 0x06, 0x00), screen_rect);
    gd.draw(RDPEllipseSC(Rect(845, 88, 5, 15), GREEN, 0x06, 0x01), screen_rect);

    gd.draw(RDPEllipseSC(Rect(700, 88, 10, 10), GREEN, 0x0D, 0x00), screen_rect);
    gd.draw(RDPEllipseSC(Rect(715, 88, 10, 10), GREEN, 0x0D, 0x01), screen_rect);
    gd.draw(RDPEllipseSC(Rect(730, 88, 10, 10), GREEN, 0x06, 0x00), screen_rect);
    gd.draw(RDPEllipseSC(Rect(745, 88, 10, 10), GREEN, 0x06, 0x01), screen_rect);

    gd.draw(RDPEllipseSC(Rect(700, 888, 40, 30), RED, 0x0D, 0x00), screen_rect);
    gd.draw(RDPEllipseSC(Rect(750, 888, 40, 30), GREEN, 0x0D, 0x01), screen_rect);
    gd.draw(RDPEllipseSC(Rect(800, 888, 40, 30), MEDIUM_BLUE, 0x06, 0x00), screen_rect);
    gd.draw(RDPEllipseSC(Rect(850, 888, 40, 30), BLUE, 0x06, 0x01), screen_rect);

    gd.draw(RDPEllipseSC(Rect(700, 930, 30, 40), RED, 0x0D, 0x00), screen_rect);
    gd.draw(RDPEllipseSC(Rect(750, 930, 30, 40), GREEN, 0x0D, 0x01), screen_rect);
    gd.draw(RDPEllipseSC(Rect(800, 930, 30, 40), MEDIUM_BLUE, 0x06, 0x00), screen_rect);
    gd.draw(RDPEllipseSC(Rect(850, 930, 30, 40), BLUE, 0x06, 0x01), screen_rect);

    gd.draw(RDPEllipseSC(Rect(700, 600, 230, 140), RED, 0x0D, 0x00), screen_rect);
    gd.draw(RDPEllipseSC(Rect(750, 530, 310, 240), GREEN, 0x07, 0x01), screen_rect);
    gd.draw(RDPEllipseSC(Rect(800, 700, 130, 140), MEDIUM_BLUE, 0x0E, 0x00), screen_rect);
    gd.draw(RDPEllipseSC(Rect(880, 700, 130, 40), BLUE, 0x06, 0x01), screen_rect);

    gd.draw(RDPEllipseSC(Rect(600, 300, 120, 120), RED, 0x0D, 0x00), screen_rect);
    gd.draw(RDPEllipseSC(Rect(650, 300, 130, 130), GREEN, 0x07, 0x01), screen_rect);
    gd.draw(RDPEllipseSC(Rect(700, 300, 140, 140), MEDIUM_BLUE, 0x0E, 0x00), screen_rect);
    gd.draw(RDPEllipseSC(Rect(750, 300, 130, 130), BLUE, 0x06, 0x01), screen_rect);

    gd.draw(RDPEllipseSC(Rect(900, 20, 120, 130), RED, 0x0D, 0x00), screen_rect);
    gd.draw(RDPEllipseSC(Rect(1000, 30, 120, 130), GREEN, 0x07, 0x01), screen_rect);
    gd.draw(RDPEllipseSC(Rect(910, 200, 120, 140), MEDIUM_BLUE, 0x0E, 0x00), screen_rect);
    gd.draw(RDPEllipseSC(Rect(1000, 180, 140, 120), BLUE, 0x06, 0x01), screen_rect);

    gd.draw(RDPEllipseSC(Rect(1000, 400, 130, 140), RED, 0x0D, 0x00), screen_rect);
    gd.draw(RDPEllipseSC(Rect(1100, 550, 140, 130), BLUE, 0x0D, 0x00), screen_rect);

    gd.draw(RDPEllipseSC(Rect(1030, 430, 65, 70), RED, 0x0D, 0x00), screen_rect);

    // binary raster operations

    gd.draw(RDPEllipseSC(Rect(300, 10, 30, 40), RED, 0x02, 0x01), screen_rect);
    gd.draw(RDPEllipseSC(Rect(300, 55, 30, 40), RED, 0x03, 0x01), screen_rect);
    gd.draw(RDPEllipseSC(Rect(300, 105, 30, 40), RED, 0x04, 0x01), screen_rect);
    gd.draw(RDPEllipseSC(Rect(300, 155, 30, 40), RED, 0x05, 0x01), screen_rect);
    gd.draw(RDPEllipseSC(Rect(350, 10, 30, 40), RED, 0x08, 0x01), screen_rect);
    gd.draw(RDPEllipseSC(Rect(350, 55, 30, 40), RED, 0x09, 0x01), screen_rect);
    gd.draw(RDPEllipseSC(Rect(350, 105, 30, 40), RED, 0x0A, 0x01), screen_rect);
    gd.draw(RDPEllipseSC(Rect(350, 155, 30, 40), RED, 0x0C, 0x01), screen_rect);
    gd.draw(RDPEllipseSC(Rect(400, 10, 30, 40), RED, 0x0F, 0x01), screen_rect);
    gd.draw(RDPEllipseSC(Rect(400, 55, 30, 40), RED, 0x01, 0x01), screen_rect);
    gd.draw(RDPEllipseSC(Rect(400, 105, 30, 40), RED, 0x10, 0x01), screen_rect);
    gd.draw(RDPEllipseSC(Rect(400, 105, 30, 40), RED, 0x10, 0x0B), screen_rect);
    gd.draw(RDPEllipseSC(Rect(400, 155, 30, 40), RED, 0x06, 0x01), screen_rect);

    elapusec = ustime() - usec;
    elapcyc = rdtsc() - cycles;

    LOG(LOG_INFO, "elapsed time = %llu %llu %f\n", elapusec, elapcyc, (double)elapcyc / (double)elapusec);

    char message[1024];
    if (!check_sig(gd.drawable, message,
                   "\xa7\xa0\x72\x43\x8a\x05\x86\xc7\xdd\xf6"
                   "\x38\xc1\x7e\xa4\x9d\x20\x2a\x39\xdf\x4e"
                   )){
        BOOST_CHECK_MESSAGE(false, message);
    }

    // uncomment to see result in png file
    //save_to_png("/tmp/test_ellipse_001.png", gd.drawable);
}

BOOST_AUTO_TEST_CASE(TestPatBlt)
{
    // Create a simple capture image and dump it to file
    uint16_t width = 640;
    uint16_t height = 480;
    Rect screen_rect(0, 0, width, height);
    RDPDrawable gd(width, height, 24);
    gd.draw(RDPPatBlt(screen_rect, 0xFF, WHITE, WHITE, RDPBrush()), screen_rect);
    gd.draw(RDPPatBlt(screen_rect.shrink(5), 0x00, WHITE, WHITE, RDPBrush()), screen_rect);


    gd.draw(RDPOpaqueRect(screen_rect.shrink(10), RED), screen_rect);
    // RED inverted becomes CYAN
    gd.draw(RDPPatBlt(screen_rect.shrink(15), 0x55, WHITE, WHITE, RDPBrush()), screen_rect);

    gd.draw(RDPOpaqueRect(screen_rect.shrink(20), RED), screen_rect);
    // Should be Black
    gd.draw(RDPPatBlt(screen_rect.shrink(25), 0x05, 0xFFFF00, WHITE, RDPBrush()), screen_rect);

    gd.draw(RDPOpaqueRect(screen_rect.shrink(30), RED), screen_rect);
    // Should be RED
    gd.draw(RDPPatBlt(screen_rect.shrink(35), 0x0F, 0xFFFF00, WHITE, RDPBrush()), screen_rect);

    gd.draw(RDPOpaqueRect(screen_rect.shrink(40), GREEN), screen_rect);
    // Should be BLUE
    gd.draw(RDPPatBlt(screen_rect.shrink(45), 0x50, 0xFFFF00, WHITE, RDPBrush()), screen_rect);

    gd.draw(RDPOpaqueRect(screen_rect.shrink(50), GREEN), screen_rect);
    // Should be purple
    gd.draw(RDPPatBlt(screen_rect.shrink(55), 0x5A, WHITE, WHITE, RDPBrush()), screen_rect);

    gd.draw(RDPOpaqueRect(screen_rect.shrink(60), GREEN), screen_rect);
    // Should be purple
    gd.draw(RDPPatBlt(screen_rect.shrink(65), 0x5F, 0xFFFF00, WHITE, RDPBrush()), screen_rect);

    gd.draw(RDPOpaqueRect(screen_rect.shrink(70), 0xFF00FF), screen_rect);
    // Should be blue
    gd.draw(RDPPatBlt(screen_rect.shrink(75), 0xA0, 0xFFFF00, WHITE, RDPBrush()), screen_rect);

    gd.draw(RDPOpaqueRect(screen_rect.shrink(80), GREEN), screen_rect);
    // Should be GREEN
    gd.draw(RDPPatBlt(screen_rect.shrink(85), 0xA5, WHITE, WHITE, RDPBrush()), screen_rect);

    gd.draw(RDPOpaqueRect(screen_rect.shrink(90), RED), screen_rect);
    // Should be white
    gd.draw(RDPPatBlt(screen_rect.shrink(95), 0xAF, RED, WHITE, RDPBrush()), screen_rect);

    gd.draw(RDPOpaqueRect(screen_rect.shrink(100), GREEN), screen_rect);
    // Should be 0x2F2F2F Dark Grey
    gd.draw(RDPPatBlt(screen_rect.shrink(105), 0xF0, 0x2F2F2F, WHITE, RDPBrush()), screen_rect);

    gd.draw(RDPOpaqueRect(screen_rect.shrink(110), 0xFF00FF), screen_rect);
    // Should be yellow
    gd.draw(RDPPatBlt(screen_rect.shrink(115), 0xF5, RED, WHITE, RDPBrush()), screen_rect);

    gd.draw(RDPOpaqueRect(screen_rect.shrink(120), RED), screen_rect);
    // Should be purple
    gd.draw(RDPPatBlt(screen_rect.shrink(125), 0xFA, BLUE, WHITE, RDPBrush()), screen_rect);

    char message[1024];
    if (!check_sig(gd.drawable, message,
        "\x87\x16\x73\x28\x21\x64\x9a\x4a\xea\x25\x60\xe5\x40\x32\x6e\xac\x28\x63\xe5\xad"
    )){
        BOOST_CHECK_MESSAGE(false, message);
    }

    // uncomment to see result in png file
    //dump_png("/tmp/test_patblt_000_", gd.drawable);
}

BOOST_AUTO_TEST_CASE(TestDestBlt)
{
    // Create a simple capture image and dump it to file
    uint16_t width = 640;
    uint16_t height = 480;
    Rect screen_rect(0, 0, width, height);
    RDPDrawable gd(width, height, 24);
    //gd.draw(RDPPatBlt(screen_rect, 0xFF, WHITE, WHITE, RDPBrush()), screen_rect);
    gd.draw(RDPDestBlt(screen_rect, 0xFF), screen_rect); // WHITENESS
    gd.draw(RDPDestBlt(screen_rect.shrink(5), 0x00), screen_rect); // BLACKNESS
    gd.draw(RDPOpaqueRect(screen_rect.shrink(10), RED), screen_rect); // RED
    // RED inverted becomes CYAN
    gd.draw(RDPDestBlt(screen_rect.shrink(15), 0x55), screen_rect);

    char message[1024];
    if (!check_sig(gd.drawable, message,
    "\x5b\x24\xc7\xec\x13\x7f\xf9\x8a\x32\x59\x62\x50\xef\x6b\x37\x1f\x15\x14\xfc\xbb"
    )){
        BOOST_CHECK_MESSAGE(false, message);
    }

    // uncomment to see result in png file
    //dump_png("/tmp/test_destblt_000_", gd.drawable);
}

BOOST_AUTO_TEST_CASE(TestAddMouse)
{
    // Create a simple capture image and dump it to file
    uint16_t width = 640;
    uint16_t height = 480;
    Rect screen_rect(0, 0, width, height);
    RDPDrawable gd(width, height, 24);

    gd.draw(RDPOpaqueRect(screen_rect, RED), screen_rect); // RED
    gd.drawable.set_mouse_cursor_pos(100, 100);
    gd.drawable.trace_mouse();

    {
        char message[1024];
        if (!check_sig(gd.drawable, message,
        "\x75\xc6\xe6\x3b\xd3\x22\x88\x14\x27\x03\xf3\x3e\x3c\x90\x5f\xac\xc1\x5c\x61\xa0"
        )){
            BOOST_CHECK_MESSAGE(false, message);
        }
    }

    // uncomment to see result in png file
    //dump_png("/tmp/test_mouse_000_", gd.drawable);

    gd.drawable.clear_mouse();

    {
        char message[1024];
        if (!check_sig(gd.drawable, message,
        "\x2b\x74\x99\xee\x6a\x39\x35\x8b\x87\xe3\x61\xa7\x8f\x91\x38\xdd\x72\xb3\x46\x05"
        )){
            BOOST_CHECK_MESSAGE(false, message);
        }
    }

    // uncomment to see result in png file
    //dump_png("/tmp/test_mouse_001_", gd.drawable);
}

BOOST_AUTO_TEST_CASE(TestAddMouse2)
{
    // Create a simple capture image and dump it to file
    uint16_t width  = 640;
    uint16_t height = 480;
    Rect screen_rect(0, 0, width, height);
    RDPDrawable gd(width, height, 24);

    gd.draw(RDPOpaqueRect(screen_rect, BLACK), screen_rect); // BLACK
    gd.drawable.set_mouse_cursor_pos(638, 470);
    gd.drawable.trace_mouse();

    {
        char message[1024];
        if (!check_sig(gd.drawable, message,
        "\xd1\x1b\xe6\x6b\x0a\x66\x87\xd2\x06\x07\x5a\x52\x90\x8a\x37\xc7\x8c\x46\x46\x4b"
        )) {
            BOOST_CHECK_MESSAGE(false, message);
        }
    }

    // uncomment to see result in png file
    //dump_png("test_mouse2_visible_", gd.drawable);

    gd.drawable.clear_mouse();

    {
        char message[1024];
        if (!check_sig(gd.drawable, message,
        "\xf9\x71\xf3\x63\x57\xcc\x45\x41\x40\x90\xce\xce\xce\x55\xa9\x1e\xe1\x9a\xab\x29"
        )) {
            BOOST_CHECK_MESSAGE(false, message);
        }
    }

    // uncomment to see result in png file
    //dump_png("test_mouse2_clear_", gd.drawable);
}

BOOST_AUTO_TEST_CASE(TestAddMouse3)
{
    // Create a simple capture image and dump it to file
    uint16_t width  = 640;
    uint16_t height = 480;
    Rect screen_rect(0, 0, width, height);
    RDPDrawable gd(width, height, 24);

    gd.drawable.default_pointer.hotspot_x = 8;
    gd.drawable.default_pointer.hotspot_y = 8;

    gd.draw(RDPOpaqueRect(screen_rect, RED), screen_rect); // RED
    gd.drawable.set_mouse_cursor_pos(0, 0);
    gd.drawable.trace_mouse();

    {
        char message[1024];
        if (!check_sig(gd.drawable, message,
        "\xec\x2b\xf0\xb0\xe0\x8a\x60\x64\xba\x8d\x2d\xbb\x33\xc7\x58\xd0\x4b\x19\x21\x3f"
        )) {
            BOOST_CHECK_MESSAGE(false, message);
        }
    }

    // uncomment to see result in png file
    //dump_png("test_mouse3_visible_", gd.drawable);

    gd.drawable.clear_mouse();

    {
        char message[1024];
        if (!check_sig(gd.drawable, message,
        "\x2b\x74\x99\xee\x6a\x39\x35\x8b\x87\xe3\x61\xa7\x8f\x91\x38\xdd\x72\xb3\x46\x05"
        )) {
            BOOST_CHECK_MESSAGE(false, message);
        }
    }

    // uncomment to see result in png file
    //dump_png("test_mouse3_clear_", gd.drawable);
}

BOOST_AUTO_TEST_CASE(TestTimestampMouse)
{
    // Create a simple capture image and dump it to file
    uint16_t width = 640;
    uint16_t height = 480;
    Rect screen_rect(0, 0, width, height);
    RDPDrawable gd(width, height, 24);
    gd.draw(RDPOpaqueRect(screen_rect, RED), screen_rect); // RED

    time_t rawtime;
    time(&rawtime);
    struct tm now;

    now.tm_sec  =  51;
    now.tm_min  =  11;
    now.tm_hour =  13;
    now.tm_mday =   8;
    now.tm_mon  =   2;
    now.tm_year = 112;
    now.tm_wday =   4;
    now.tm_yday =  67;
    now.tm_isdst =  0;

    gd.drawable.trace_timestamp(now);

    {
        char message[1024];
        if (!check_sig(gd.drawable, message,
        "\x0d\x64\x40\x8c\xcb\x82\xd6\x29\x9b\x55\x83\x87\x3d\xd9\x69\xb6\xd7\x5b\x0d\x3d"
        )){
            BOOST_CHECK_MESSAGE(false, message);
        }
    }

    // uncomment to see result in png file
    //dump_png("/tmp/test_timestamp_000_", gd.drawable);


    now.tm_sec  =  00;
    now.tm_min  =  12;
    now.tm_hour =  13;
    now.tm_mday =   8;
    now.tm_mon  =   2;
    now.tm_year = 113;
    now.tm_wday =   4;
    now.tm_yday =  67;
    now.tm_isdst =  0;

    gd.drawable.clear_timestamp();
    gd.drawable.trace_timestamp(now);

    {
        char message[1024];
        if (!check_sig(gd.drawable, message,
        "\x9c\x75\xcc\x7e\x0e\xa2\x3b\x61\xef\x53\x9a\x64\x66\x06\x57\x05\xa1\xe6\x4f\xf0"
        )){
            BOOST_CHECK_MESSAGE(false, message);
        }
    }

    // uncomment to see result in png file
    //dump_png("/tmp/test_timestamp_001_", gd.drawable);


    gd.drawable.clear_timestamp();

    {
        char message[1024];
        if (!check_sig(gd.drawable, message,
        "\x2b\x74\x99\xee\x6a\x39\x35\x8b\x87\xe3\x61\xa7\x8f\x91\x38\xdd\x72\xb3\x46\x05"
        )){
            BOOST_CHECK_MESSAGE(false, message);
        }
    }

    // uncomment to see result in png file
    //dump_png("/tmp/test_timestamp_002_", gd.drawable);
}

TODO("We should perform exhaustive tests on scrblt like for patblt, current tests are not exhaustive.")
void test_scrblt(const uint8_t rop, const int cx, const int cy, const char * name, const char * shasig){
    // Create a simple capture image and dump it to file
    uint16_t width = 640;
    uint16_t height = 480;
    Rect screen_rect(0, 0, width, height);
    RDPDrawable gd(width, height, 24);
    gd.draw(RDPOpaqueRect(Rect(90, 90, 120, 120), RED), screen_rect);
    gd.draw(RDPOpaqueRect(screen_rect, BLUE), Rect(100, 100, 100, 100));
    gd.draw(RDPOpaqueRect(Rect(120, 120, 60, 60), PINK), Rect(100, 100, 100, 100));
    gd.drawable.scrblt(90, 90, Rect(300, 300, 120, 120), 0xCC);
    gd.drawable.scrblt(90, 90, Rect(90 + cx, 90 + cy, 120, 120), rop);

    char message[1024];
    if (!check_sig(gd.drawable, message, shasig)){
        BOOST_CHECK_MESSAGE(false, message);
    }

    // uncomment to see result in png file
    //char tmpname[128];
    //sprintf(tmpname, "/tmp/test_scrblt_%s", name);
    //dump_png(tmpname, gd.drawable);
}

bool test_scrblt2(const uint8_t rop, const int cx, const int cy, const char * name, const char * shasig, char * message){
    // Create a simple capture image and dump it to file
    uint16_t width = 640;
    uint16_t height = 480;
    Rect screen_rect(0, 0, width, height);
    RDPDrawable gd(width, height, 24);
    gd.draw(RDPOpaqueRect(Rect(90, 90, 120, 120), RED), screen_rect);
    gd.draw(RDPOpaqueRect(screen_rect, BLUE), Rect(100, 100, 100, 100));
    gd.draw(RDPOpaqueRect(Rect(120, 120, 60, 60), PINK), Rect(100, 100, 100, 100));
    gd.drawable.scrblt(90, 90, Rect(300, 300, 120, 120), 0xCC);
    gd.drawable.scrblt(90, 90, Rect(90 + cx, 90 + cy, 120, 120), rop);

    // uncomment to see result in png file
    //char tmpname[128];
    //sprintf(tmpname, "/tmp/test_scrblt_%s", name);
    //dump_png(tmpname, gd.drawable);

    return check_sig(gd.drawable, message, shasig);
}

BOOST_AUTO_TEST_CASE(TestDrawableScrBltDown)
{
    char message[1024];
    int res = test_scrblt2(0x00, 0, 20, "down00",
    "\xf8\xbd\xd7\x1d\x93\x78\x8c\xd9\x7a\x88\x6d\xfe\x52\x71\xe5\xaf\x7d\xba\x61\x46"
    , message);
    if (!res){
        BOOST_CHECK_MESSAGE(false, message);
    }
}

//BOOST_AUTO_TEST_CASE(TestDrawableScrBltDown)
//{
//    test_scrblt(0x00, 0, 20, "down00",
//    "\x3c\x39\xae\x2b\x84\x5b\xc6\xa8\x75\xc1\xaf\xbb\x5c\x26\xa9\x1f\x94\x24\xc4\x68");
//}

BOOST_AUTO_TEST_CASE(TestDrawableScrBltRight)
{
    char message[1024];
    int res = test_scrblt2(0x00, 20, 0, "right00",
    "\x76\xbb\x56\xf5\x70\xec\x7e\x19\xc7\x68\xe6\x32\xb3\x43\xf1\xc8\xf1\x78\x6e\xf1"
    , message);
    if (!res){
        BOOST_CHECK_MESSAGE(false, message);
    }
}

BOOST_AUTO_TEST_CASE(TestDrawableScrBltLeft)
{
    char message[1024];
    int res = test_scrblt2(0x00, -20, 0, "left00",
    "\x05\xdf\xba\x3b\x9f\xa9\x5d\x1c\xa9\x12\xa0\x0b\x1d\x10\x26\x68\x41\xc7\x73\xd9"
    , message);
    if (!res){
        BOOST_CHECK_MESSAGE(false, message);
    }
}

BOOST_AUTO_TEST_CASE(TestDrawableScrBltUp)
{
    char message[1024];
    int res = test_scrblt2(0x00, 0, -20, "up00",
    "\x55\x73\x7e\xd8\x0a\x36\xde\x1c\x87\xb3\xbb\x78\x6c\xaf\xb2\xcf\x53\xab\xa2\xe6"
    , message);
    if (!res){
        BOOST_CHECK_MESSAGE(false, message);
    }
}

BOOST_AUTO_TEST_CASE(TestDrawableScrBltLeftUp)
{
    char message[1024];
    int res = test_scrblt2(0x00, -20, -20, "left_up00",
    "\xb6\x9a\xe7\xd0\x97\xe1\x3b\xce\x8d\xef\x73\x43\xd2\x50\xba\xd0\x06\xe1\x6c\xca"
    , message);
    if (!res){
        BOOST_CHECK_MESSAGE(false, message);
    }
}

BOOST_AUTO_TEST_CASE(TestDrawableScrBltDown11)
{
    char message[1024];
    int res = test_scrblt2(0x11, 0, 20, "down11",
    "\x20\xd5\x27\xaa\x91\xff\xa5\x21\x91\xe8\x94\x08\x6d\x7f\xb3\x52\x38\x62\x96\x2b"
    , message);
    if (!res){
        BOOST_CHECK_MESSAGE(false, message);
    }
}

BOOST_AUTO_TEST_CASE(TestDrawableScrBltRight11)
{
    char message[1024];
    int res = test_scrblt2(0x11, 20, 0, "right11",
    "\x85\x82\xdd\x28\x3c\x75\x9c\xdb\xc3\x94\xc8\xd3\x67\x7e\xdf\x76\xfb\x74\x84\x30"
    , message);
    if (!res){
        BOOST_CHECK_MESSAGE(false, message);
    }
}

BOOST_AUTO_TEST_CASE(TestDrawableScrBltLeft11)
{
    char message[1024];
    int res = test_scrblt2(0x11, -20, 0, "left11",
    "\x44\xb8\x04\x46\xf6\x80\x67\x05\x5c\xaf\xb4\xd1\xa3\xcc\x56\x9c\xd6\x97\x1f\x67"
    , message);
    if (!res){
        BOOST_CHECK_MESSAGE(false, message);
    }
}

BOOST_AUTO_TEST_CASE(TestDrawableScrBltUp11)
{
    char message[1024];
    int res = test_scrblt2(0x11, 0, -20, "up11",
    "\x8e\xdb\x52\x5b\x59\x6f\xfc\x9c\x70\x6e\x1f\x4d\x73\xad\x46\xa8\x01\xea\xe3\x4d"
    , message);
    if (!res){
        BOOST_CHECK_MESSAGE(false, message);
    }
}

BOOST_AUTO_TEST_CASE(TestDrawableScrBltLeftUp11)
{
    char message[1024];
    int res = test_scrblt2(0x11, -20, -20, "left_up11",
    "\x5a\xa8\xea\x06\xa6\xa3\xa0\x57\x76\xcb\xc0\xb5\xc3\xb7\x53\x5e\x2b\x7f\xad\x9c"
    , message);
    if (!res){
        BOOST_CHECK_MESSAGE(false, message);
    }
}

BOOST_AUTO_TEST_CASE(TestMemblt)
{
    // Create a simple capture image and dump it to file
    uint16_t width = 640;
    uint16_t height = 480;
    Rect screen_rect(0, 0, width, height);
    BGRPalette palette;
    init_palette332(palette);

    RDPDrawable gd(width, height, 24);
    gd.draw(RDPOpaqueRect(screen_rect, 0x2F2F2F), screen_rect);
    gd.draw(RDPOpaqueRect(Rect(100,100,20, 20), BLUE), screen_rect);

    uint8_t comp64x64RED[] = { 0xc0, 0x30, 0x00, 0x00, 0xFF, 0xf0, 0xc0, 0x0f, };
    BGRPalette palette332;
    init_palette332(palette332);
    Bitmap bmp(24, 24, &palette332, 64, 64, comp64x64RED, sizeof(comp64x64RED), true );

    // red square
    gd.draw(RDPMemBlt(1, Rect(5, 5, 20, 20), 0xCC, 0, 0, 10), screen_rect, bmp);
    // inverted red square (cyan)
    gd.draw(RDPMemBlt(1, Rect(25, 25, 20, 20), 0x55, 0, 0, 10), screen_rect, bmp);
    // black square
    gd.draw(RDPMemBlt(1, Rect(45, 45, 20, 20), 0x00, 0, 0, 10), screen_rect, bmp);
    // white square
    gd.draw(RDPMemBlt(1, Rect(65, 65, 20, 20), 0xFF, 0, 0, 10), screen_rect, bmp);

    char message[1024];
    if (!check_sig(gd.drawable, message,
    "\x98\x6c\x40\x0b\x3a\xbc\x39\x38\x29\x11\x77\x37\x98\xe2\x27\xb2\xcb\x61\xec\x5d"
    )){
        BOOST_CHECK_MESSAGE(false, message);
    }

    // uncomment to see result in png file
    //dump_png("./test_memblt_", gd.drawable);
}

BOOST_AUTO_TEST_CASE(TestMemblt2)
{
    // Create a simple capture image and dump it to file
    uint16_t width = 320;
    uint16_t height = 200;
    Rect screen_rect(0, 0, width, height);
    BGRPalette palette;

    RDPDrawable gd(width, height, 24);
    gd.draw(RDPOpaqueRect(screen_rect, 0x2F2F2F), screen_rect);

    uint8_t raw_palette[] = {
/* 0000 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x00, 0x00, 0x80, 0x00, 0x00, 0x00, 0x80, 0x80, 0x00,  // ................
/* 0010 */ 0x80, 0x00, 0x00, 0x00, 0x80, 0x00, 0x80, 0x00, 0x80, 0x80, 0x00, 0x00, 0xc0, 0xc0, 0xc0, 0x00,  // ................
/* 0020 */ 0xc0, 0xdc, 0xc0, 0x00, 0xc8, 0xd0, 0xd4, 0x00, 0x01, 0x1f, 0x3f, 0x00, 0x01, 0x1f, 0x5f, 0x00,  // ..........?..._.
/* 0030 */ 0x01, 0x1f, 0x7f, 0x00, 0x01, 0x1f, 0x9f, 0x00, 0x01, 0x1f, 0xbf, 0x00, 0x01, 0x1f, 0xdf, 0x00,  // ................
/* 0040 */ 0x01, 0x3f, 0x01, 0x00, 0x01, 0x3f, 0x1f, 0x00, 0x01, 0x3f, 0x3f, 0x00, 0x01, 0x3f, 0x5f, 0x00,  // .?...?...??..?_.
/* 0050 */ 0x01, 0x3f, 0x7f, 0x00, 0x01, 0x3f, 0x9f, 0x00, 0x01, 0x3f, 0xbf, 0x00, 0x01, 0x3f, 0xdf, 0x00,  // .?...?...?...?..
/* 0060 */ 0x01, 0x5f, 0x01, 0x00, 0x01, 0x5f, 0x1f, 0x00, 0x01, 0x5f, 0x3f, 0x00, 0x01, 0x5f, 0x5f, 0x00,  // ._..._..._?..__.
/* 0070 */ 0x01, 0x5f, 0x7f, 0x00, 0x01, 0x5f, 0x9f, 0x00, 0x01, 0x5f, 0xbf, 0x00, 0x01, 0x5f, 0xdf, 0x00,  // ._..._..._..._..
/* 0080 */ 0x01, 0x7f, 0x01, 0x00, 0x01, 0x7f, 0x1f, 0x00, 0x01, 0x7f, 0x3f, 0x00, 0x01, 0x7f, 0x5f, 0x00,  // ..........?..._.
/* 0090 */ 0x01, 0x7f, 0x7f, 0x00, 0x01, 0x7f, 0x9f, 0x00, 0x01, 0x7f, 0xbf, 0x00, 0x01, 0x7f, 0xdf, 0x00,  // ................
/* 00a0 */ 0x01, 0x9f, 0x01, 0x00, 0x01, 0x9f, 0x1f, 0x00, 0x01, 0x9f, 0x3f, 0x00, 0x01, 0x9f, 0x5f, 0x00,  // ..........?..._.
/* 00b0 */ 0x01, 0x9f, 0x7f, 0x00, 0x01, 0x9f, 0x9f, 0x00, 0x01, 0x9f, 0xbf, 0x00, 0x01, 0x9f, 0xdf, 0x00,  // ................
/* 00c0 */ 0x01, 0xbf, 0x01, 0x00, 0x01, 0xbf, 0x1f, 0x00, 0x01, 0xbf, 0x3f, 0x00, 0x01, 0xbf, 0x5f, 0x00,  // ..........?..._.
/* 00d0 */ 0x01, 0xbf, 0x7f, 0x00, 0x01, 0xbf, 0x9f, 0x00, 0x01, 0xbf, 0xbf, 0x00, 0x01, 0xbf, 0xdf, 0x00,  // ................
/* 00e0 */ 0x01, 0xdf, 0x01, 0x00, 0x01, 0xdf, 0x1f, 0x00, 0x01, 0xdf, 0x3f, 0x00, 0x01, 0xdf, 0x5f, 0x00,  // ..........?..._.
/* 00f0 */ 0x01, 0xdf, 0x7f, 0x00, 0x01, 0xdf, 0x9f, 0x00, 0x01, 0xdf, 0xbf, 0x00, 0x01, 0xdf, 0xdf, 0x00,  // ................
/* 0100 */ 0x3f, 0x01, 0x01, 0x00, 0x3f, 0x01, 0x1f, 0x00, 0x3f, 0x01, 0x3f, 0x00, 0x3f, 0x01, 0x5f, 0x00,  // ?...?...?.?.?._.
/* 0110 */ 0x3f, 0x01, 0x7f, 0x00, 0x3f, 0x01, 0x9f, 0x00, 0x3f, 0x01, 0xbf, 0x00, 0x3f, 0x01, 0xdf, 0x00,  // ?...?...?...?...
/* 0120 */ 0x3f, 0x1f, 0x01, 0x00, 0x3f, 0x1f, 0x1f, 0x00, 0x3f, 0x1f, 0x3f, 0x00, 0x3f, 0x1f, 0x5f, 0x00,  // ?...?...?.?.?._.
/* 0130 */ 0x3f, 0x1f, 0x7f, 0x00, 0x3f, 0x1f, 0x9f, 0x00, 0x3f, 0x1f, 0xbf, 0x00, 0x3f, 0x1f, 0xdf, 0x00,  // ?...?...?...?...
/* 0140 */ 0x3f, 0x3f, 0x01, 0x00, 0x3f, 0x3f, 0x1f, 0x00, 0x3f, 0x3f, 0x3f, 0x00, 0x3f, 0x3f, 0x5f, 0x00,  // ??..??..???.??_.
/* 0150 */ 0x3f, 0x3f, 0x7f, 0x00, 0x3f, 0x3f, 0x9f, 0x00, 0x3f, 0x3f, 0xbf, 0x00, 0x3f, 0x3f, 0xdf, 0x00,  // ??..??..??..??..
/* 0160 */ 0x3f, 0x5f, 0x01, 0x00, 0x3f, 0x5f, 0x1f, 0x00, 0x3f, 0x5f, 0x3f, 0x00, 0x3f, 0x5f, 0x5f, 0x00,  // ?_..?_..?_?.?__.
/* 0170 */ 0x3f, 0x5f, 0x7f, 0x00, 0x3f, 0x5f, 0x9f, 0x00, 0x3f, 0x5f, 0xbf, 0x00, 0x3f, 0x5f, 0xdf, 0x00,  // ?_..?_..?_..?_..
/* 0180 */ 0x3f, 0x7f, 0x01, 0x00, 0x3f, 0x7f, 0x1f, 0x00, 0x3f, 0x7f, 0x3f, 0x00, 0x3f, 0x7f, 0x5f, 0x00,  // ?...?...?.?.?._.
/* 0190 */ 0x3f, 0x7f, 0x7f, 0x00, 0x3f, 0x7f, 0x9f, 0x00, 0x3f, 0x7f, 0xbf, 0x00, 0x3f, 0x7f, 0xdf, 0x00,  // ?...?...?...?...
/* 01a0 */ 0x3f, 0x9f, 0x01, 0x00, 0x3f, 0x9f, 0x1f, 0x00, 0x3f, 0x9f, 0x3f, 0x00, 0x3f, 0x9f, 0x5f, 0x00,  // ?...?...?.?.?._.
/* 01b0 */ 0x3f, 0x9f, 0x7f, 0x00, 0x3f, 0x9f, 0x9f, 0x00, 0x3f, 0x9f, 0xbf, 0x00, 0x3f, 0x9f, 0xdf, 0x00,  // ?...?...?...?...
/* 01c0 */ 0x3f, 0xbf, 0x01, 0x00, 0x3f, 0xbf, 0x1f, 0x00, 0x3f, 0xbf, 0x3f, 0x00, 0x3f, 0xbf, 0x5f, 0x00,  // ?...?...?.?.?._.
/* 01d0 */ 0x3f, 0xbf, 0x7f, 0x00, 0x3f, 0xbf, 0x9f, 0x00, 0x3f, 0xbf, 0xbf, 0x00, 0x3f, 0xbf, 0xdf, 0x00,  // ?...?...?...?...
/* 01e0 */ 0x3f, 0xdf, 0x01, 0x00, 0x3f, 0xdf, 0x1f, 0x00, 0x3f, 0xdf, 0x3f, 0x00, 0x3f, 0xdf, 0x5f, 0x00,  // ?...?...?.?.?._.
/* 01f0 */ 0x3f, 0xdf, 0x7f, 0x00, 0x3f, 0xdf, 0x9f, 0x00, 0x3f, 0xdf, 0xbf, 0x00, 0x3f, 0xdf, 0xdf, 0x00,  // ?...?...?...?...
/* 0200 */ 0x7f, 0x01, 0x01, 0x00, 0x7f, 0x01, 0x1f, 0x00, 0x7f, 0x01, 0x3f, 0x00, 0x7f, 0x01, 0x5f, 0x00,  // ..........?..._.
/* 0210 */ 0x7f, 0x01, 0x7f, 0x00, 0x7f, 0x01, 0x9f, 0x00, 0x7f, 0x01, 0xbf, 0x00, 0x7f, 0x01, 0xdf, 0x00,  // ................
/* 0220 */ 0x7f, 0x1f, 0x01, 0x00, 0x7f, 0x1f, 0x1f, 0x00, 0x7f, 0x1f, 0x3f, 0x00, 0x7f, 0x1f, 0x5f, 0x00,  // ..........?..._.
/* 0230 */ 0x7f, 0x1f, 0x7f, 0x00, 0x7f, 0x1f, 0x9f, 0x00, 0x7f, 0x1f, 0xbf, 0x00, 0x7f, 0x1f, 0xdf, 0x00,  // ................
/* 0240 */ 0x7f, 0x3f, 0x01, 0x00, 0x7f, 0x3f, 0x1f, 0x00, 0x7f, 0x3f, 0x3f, 0x00, 0x7f, 0x3f, 0x5f, 0x00,  // .?...?...??..?_.
/* 0250 */ 0x7f, 0x3f, 0x7f, 0x00, 0x7f, 0x3f, 0x9f, 0x00, 0x7f, 0x3f, 0xbf, 0x00, 0x7f, 0x3f, 0xdf, 0x00,  // .?...?...?...?..
/* 0260 */ 0x7f, 0x5f, 0x01, 0x00, 0x7f, 0x5f, 0x1f, 0x00, 0x7f, 0x5f, 0x3f, 0x00, 0x7f, 0x5f, 0x5f, 0x00,  // ._..._..._?..__.
/* 0270 */ 0x7f, 0x5f, 0x7f, 0x00, 0x7f, 0x5f, 0x9f, 0x00, 0x7f, 0x5f, 0xbf, 0x00, 0x7f, 0x5f, 0xdf, 0x00,  // ._..._..._..._..
/* 0280 */ 0x7f, 0x7f, 0x01, 0x00, 0x7f, 0x7f, 0x1f, 0x00, 0x7f, 0x7f, 0x3f, 0x00, 0x7f, 0x7f, 0x5f, 0x00,  // ..........?..._.
/* 0290 */ 0x7f, 0x7f, 0x7f, 0x00, 0x7f, 0x7f, 0x9f, 0x00, 0x7f, 0x7f, 0xbf, 0x00, 0x7f, 0x7f, 0xdf, 0x00,  // ................
/* 02a0 */ 0x7f, 0x9f, 0x01, 0x00, 0x7f, 0x9f, 0x1f, 0x00, 0x7f, 0x9f, 0x3f, 0x00, 0x7f, 0x9f, 0x5f, 0x00,  // ..........?..._.
/* 02b0 */ 0x7f, 0x9f, 0x7f, 0x00, 0x7f, 0x9f, 0x9f, 0x00, 0x7f, 0x9f, 0xbf, 0x00, 0x7f, 0x9f, 0xdf, 0x00,  // ................
/* 02c0 */ 0x7f, 0xbf, 0x01, 0x00, 0x7f, 0xbf, 0x1f, 0x00, 0x7f, 0xbf, 0x3f, 0x00, 0x7f, 0xbf, 0x5f, 0x00,  // ..........?..._.
/* 02d0 */ 0x7f, 0xbf, 0x7f, 0x00, 0x7f, 0xbf, 0x9f, 0x00, 0x7f, 0xbf, 0xbf, 0x00, 0x7f, 0xbf, 0xdf, 0x00,  // ................
/* 02e0 */ 0x7f, 0xdf, 0x01, 0x00, 0x7f, 0xdf, 0x1f, 0x00, 0x7f, 0xdf, 0x3f, 0x00, 0x7f, 0xdf, 0x5f, 0x00,  // ..........?..._.
/* 02f0 */ 0x7f, 0xdf, 0x7f, 0x00, 0x7f, 0xdf, 0x9f, 0x00, 0x7f, 0xdf, 0xbf, 0x00, 0x7f, 0xdf, 0xdf, 0x00,  // ................
/* 0300 */ 0xbf, 0x01, 0x01, 0x00, 0xbf, 0x01, 0x1f, 0x00, 0xbf, 0x01, 0x3f, 0x00, 0xbf, 0x01, 0x5f, 0x00,  // ..........?..._.
/* 0310 */ 0xbf, 0x01, 0x7f, 0x00, 0xbf, 0x01, 0x9f, 0x00, 0xbf, 0x01, 0xbf, 0x00, 0xbf, 0x01, 0xdf, 0x00,  // ................
/* 0320 */ 0xbf, 0x1f, 0x01, 0x00, 0xbf, 0x1f, 0x1f, 0x00, 0xbf, 0x1f, 0x3f, 0x00, 0xbf, 0x1f, 0x5f, 0x00,  // ..........?..._.
/* 0330 */ 0xbf, 0x1f, 0x7f, 0x00, 0xbf, 0x1f, 0x9f, 0x00, 0xbf, 0x1f, 0xbf, 0x00, 0xbf, 0x1f, 0xdf, 0x00,  // ................
/* 0340 */ 0xbf, 0x3f, 0x01, 0x00, 0xbf, 0x3f, 0x1f, 0x00, 0xbf, 0x3f, 0x3f, 0x00, 0xbf, 0x3f, 0x5f, 0x00,  // .?...?...??..?_.
/* 0350 */ 0xbf, 0x3f, 0x7f, 0x00, 0xbf, 0x3f, 0x9f, 0x00, 0xbf, 0x3f, 0xbf, 0x00, 0xbf, 0x3f, 0xdf, 0x00,  // .?...?...?...?..
/* 0360 */ 0xbf, 0x5f, 0x01, 0x00, 0xbf, 0x5f, 0x1f, 0x00, 0xbf, 0x5f, 0x3f, 0x00, 0xbf, 0x5f, 0x5f, 0x00,  // ._..._..._?..__.
/* 0370 */ 0xbf, 0x5f, 0x7f, 0x00, 0xbf, 0x5f, 0x9f, 0x00, 0xbf, 0x5f, 0xbf, 0x00, 0xbf, 0x5f, 0xdf, 0x00,  // ._..._..._..._..
/* 0380 */ 0xbf, 0x7f, 0x01, 0x00, 0xbf, 0x7f, 0x1f, 0x00, 0xbf, 0x7f, 0x3f, 0x00, 0xbf, 0x7f, 0x5f, 0x00,  // ..........?..._.
/* 0390 */ 0xbf, 0x7f, 0x7f, 0x00, 0xbf, 0x7f, 0x9f, 0x00, 0xbf, 0x7f, 0xbf, 0x00, 0xbf, 0x7f, 0xdf, 0x00,  // ................
/* 03a0 */ 0xbf, 0x9f, 0x01, 0x00, 0xbf, 0x9f, 0x1f, 0x00, 0xbf, 0x9f, 0x3f, 0x00, 0xbf, 0x9f, 0x5f, 0x00,  // ..........?..._.
/* 03b0 */ 0xbf, 0x9f, 0x7f, 0x00, 0xbf, 0x9f, 0x9f, 0x00, 0xbf, 0x9f, 0xbf, 0x00, 0xbf, 0x9f, 0xdf, 0x00,  // ................
/* 03c0 */ 0xbf, 0xbf, 0x01, 0x00, 0xbf, 0xbf, 0x1f, 0x00, 0xbf, 0xbf, 0x3f, 0x00, 0xbf, 0xbf, 0x5f, 0x00,  // ..........?..._.
/* 03d0 */ 0xbf, 0xbf, 0x7f, 0x00, 0xbf, 0xbf, 0x9f, 0x00, 0xf0, 0xfb, 0xff, 0x00, 0xa5, 0x6e, 0x3a, 0x00,  // .............n:.
/* 03e0 */ 0x80, 0x80, 0x80, 0x00, 0x00, 0x00, 0xff, 0x00, 0x00, 0xff, 0x00, 0x00, 0x00, 0xff, 0xff, 0x00,  // ................
/* 03f0 */ 0xff, 0x00, 0x00, 0x00, 0xff, 0x00, 0xff, 0x00, 0xff, 0xff, 0x00, 0x00, 0xff, 0xff, 0xff, 0x00,  // ................
    };
    uint8_t raw_bitmap[] = {
/* 0000 */ 0xc0, 0x30, 0x09, 0x00, 0x63, 0x30, 0x09, 0xd0, 0x14, 0xf5, 0x07, 0x00, 0x00, 0xcf, 0x09, 0x03,  // .0..c0..........
/* 0010 */ 0x84, 0x06, 0x06, 0x06, 0xfc, 0xc7, 0xf8, 0x82, 0xfc, 0x06, 0xd0, 0x0a, 0xfc, 0x03, 0x00, 0x87,  // ................
/* 0020 */ 0xfc, 0xfc, 0x09, 0x09, 0xfc, 0x00, 0x00, 0xd0, 0x13, 0x09, 0x0f, 0x00, 0x00, 0xc7, 0x01, 0x07,  // ................
/* 0030 */ 0x82, 0xfe, 0xfc, 0x69, 0x07, 0x81, 0xfc, 0xd0, 0x09, 0xfb, 0x01, 0x00, 0x8c, 0x03, 0xfc, 0x09,  // ...i............
/* 0040 */ 0x09, 0x00, 0x00, 0x04, 0x04, 0xfc, 0xfc, 0xfc, 0xfc, 0xd0, 0x0d, 0x0d, 0x03, 0x00, 0x8a, 0x01,  // ................
/* 0050 */ 0x01, 0xf9, 0xf9, 0xf9, 0xf9, 0xf9, 0xf9, 0x01, 0x01, 0x06, 0x8d, 0xfc, 0x07, 0x07, 0x00, 0x00,  // ................
/* 0060 */ 0x00, 0x00, 0x00, 0x00, 0x07, 0x07, 0x07, 0xfc, 0xd0, 0x0b, 0xfa, 0x01, 0x00, 0x83, 0x00, 0x04,  // ................
/* 0070 */ 0x04, 0x68, 0xfc, 0xd0, 0x0a, 0x0d, 0x01, 0x00, 0x83, 0x01, 0x01, 0xf9, 0x05, 0x84, 0x03, 0xf9,  // .h..............
/* 0080 */ 0xf9, 0xf9, 0x05, 0x84, 0x07, 0xff, 0x07, 0xf8, 0xd1, 0x07, 0x0f, 0x81, 0x07, 0xd0, 0x0a, 0xfa,  // ................
/* 0090 */ 0x01, 0x00, 0x8d, 0xfc, 0x04, 0x04, 0xfc, 0xfc, 0xfc, 0xf8, 0xf8, 0x00, 0xfc, 0xfc, 0xfc, 0xfc,  // ................
/* 00a0 */ 0xd0, 0x08, 0x0d, 0x01, 0x00, 0x92, 0x01, 0x01, 0xf9, 0xf9, 0xf9, 0x03, 0x03, 0x01, 0x03, 0x03,  // ................
/* 00b0 */ 0x03, 0x03, 0x03, 0x03, 0x09, 0x09, 0x09, 0xf8, 0xd0, 0x0c, 0xf8, 0x77, 0x00, 0xd0, 0x09, 0x04,  // ...........w....
/* 00c0 */ 0x01, 0x00, 0x8a, 0x03, 0xfc, 0x04, 0xfc, 0xfc, 0xfc, 0x09, 0x09, 0x09, 0x09, 0xd0, 0x0d, 0xfc,  // ................
/* 00d0 */ 0x01, 0x00, 0x8a, 0xf9, 0xf9, 0xf9, 0xf9, 0x03, 0x01, 0x04, 0x04, 0x04, 0x03, 0xd0, 0x1d, 0xf8,  // ................
/* 00e0 */ 0x01, 0x03, 0x00, 0x00, 0xd0, 0x09, 0x04, 0x01, 0x00, 0x6c, 0x09, 0x01, 0x81, 0x03, 0x05, 0x86,  // .........l......
/* 00f0 */ 0x03, 0x03, 0xf8, 0x04, 0x03, 0xfb, 0xd0, 0x0a, 0xf8, 0x81, 0x01, 0xd0, 0x11, 0xff, 0x01, 0x00,  // ................
/* 0100 */ 0x00, 0x86, 0xfb, 0x03, 0xfc, 0xfc, 0xfc, 0xfc, 0xc9, 0x0d, 0x0c, 0x86, 0x03, 0x06, 0x06, 0xf8,  // ................
/* 0110 */ 0x06, 0x04, 0xd0, 0x08, 0x07, 0x01, 0x00, 0x86, 0xff, 0x07, 0xf8, 0xff, 0x03, 0x03, 0x40, 0x0e,  // ..............@.
/* 0120 */ 0x01, 0x00, 0x81, 0x09, 0xd0, 0x19, 0xf8, 0xc3, 0x3f, 0x00, 0x00, 0x8f, 0x03, 0x03, 0x06, 0x06,  // ........?.......
/* 0130 */ 0x06, 0x06, 0x06, 0x04, 0x07, 0x07, 0x03, 0x09, 0x09, 0x09, 0x06, 0x40, 0x06, 0x45, 0x86, 0x03,  // ...........@.E..
/* 0140 */ 0x00, 0xf8, 0x07, 0x07, 0x07, 0xd0, 0x09, 0xfc, 0x01, 0x00, 0x8a, 0x04, 0x03, 0xfb, 0xfc, 0xfc,  // ................
/* 0150 */ 0xfc, 0x09, 0x09, 0x09, 0x09, 0x40, 0x0e, 0x01, 0x00, 0x9d, 0x03, 0x03, 0x03, 0xf8, 0x06, 0x06,  // .....@..........
/* 0160 */ 0x06, 0x06, 0x06, 0x06, 0x07, 0xfb, 0x09, 0x09, 0x09, 0x06, 0xfc, 0x07, 0xff, 0xf8, 0xf8, 0xf8,  // ................
/* 0170 */ 0x03, 0xfb, 0x03, 0x00, 0xf8, 0x07, 0x04, 0xd0, 0x09, 0xf8, 0x01, 0x00, 0x8e, 0x09, 0x04, 0x03,  // ................
/* 0180 */ 0xfb, 0xfc, 0xfc, 0xfc, 0x09, 0x09, 0x00, 0xfc, 0xfc, 0xfc, 0x04, 0x68, 0x09, 0xd0, 0x12, 0xfe,  // ...........h....
/* 0190 */ 0x80, 0x00, 0x00, 0x8b, 0x06, 0xfc, 0x07, 0xff, 0xff, 0x07, 0xff, 0x03, 0xfb, 0x03, 0x00, 0xd0,  // ................
/* 01a0 */ 0x0d, 0x03, 0x03, 0x00, 0x87, 0x04, 0x03, 0xfb, 0xfc, 0xfc, 0x04, 0x04, 0xd0, 0x12, 0xfc, 0x01,  // ................
/* 01b0 */ 0x00, 0x00, 0x66, 0x06, 0xfd, 0x06, 0x8c, 0xfe, 0x06, 0xfc, 0x07, 0xff, 0xff, 0xff, 0xff, 0x03,  // ..f.............
/* 01c0 */ 0xfb, 0x03, 0x00, 0xd0, 0x0b, 0xfb, 0x01, 0x00, 0x8c, 0x09, 0x04, 0xfc, 0xfc, 0xfb, 0xfc, 0xfc,  // ................
/* 01d0 */ 0xfc, 0xfc, 0xfc, 0xfc, 0x04, 0x69, 0x09, 0x01, 0x9f, 0xf9, 0x03, 0xf8, 0xf8, 0xf8, 0xf8, 0x06,  // .....i..........
/* 01e0 */ 0xfe, 0xfe, 0x06, 0x06, 0x07, 0x06, 0x00, 0x09, 0x09, 0x09, 0x06, 0x06, 0x06, 0x06, 0x06, 0xf8,  // ................
/* 01f0 */ 0xf8, 0xf8, 0xf8, 0xf8, 0x03, 0xfb, 0x03, 0x00, 0xd0, 0x0b, 0x04, 0x01, 0x00, 0x82, 0x09, 0x04,  // ................
/* 0200 */ 0x67, 0xfc, 0x83, 0x04, 0x09, 0x09, 0xd0, 0x08, 0xf5, 0x01, 0x00, 0x8e, 0x00, 0x03, 0xf8, 0xf8,  // g...............
/* 0210 */ 0x06, 0x06, 0x07, 0x07, 0xfe, 0x06, 0x07, 0x06, 0x00, 0x00, 0x6e, 0x09, 0x83, 0x03, 0xf9, 0x01,  // ..........n.....
/* 0220 */ 0x6f, 0x09, 0xd0, 0x12, 0x0d, 0x40, 0x00, 0x00, 0x82, 0x00, 0x00, 0x67, 0x07, 0x81, 0x06, 0xd0,  // o....@.....g....
/* 0230 */ 0x10, 0x06, 0x01, 0x00, 0x00, 0x81, 0x09, 0xd0, 0x10, 0xf8, 0x01, 0x00, 0x00, 0xc5, 0xf5, 0x42,  // ...............B
/* 0240 */ 0x1e, 0x00, 0x6b, 0x00, 0x0f, 0x60, 0x91, 0x09,                          // ..k..`..
    };

    memcpy(palette, raw_palette, sizeof(palette));

    Bitmap bmp(8, 8, &palette, 64, 22, raw_bitmap, sizeof(raw_bitmap), true);

    // red square
    gd.draw(RDPMemBlt(1, Rect(5, 5, 20, 20), 0xCC, 0, 0, 10), screen_rect, bmp);

    //char message[1024];
    //if (!check_sig(gd.drawable, message,
    //"\x98\x6c\x40\x0b\x3a\xbc\x39\x38\x29\x11\x77\x37\x98\xe2\x27\xb2\xcb\x61\xec\x5d"
    //)){
    //    BOOST_CHECK_MESSAGE(false, message);
    //}

    // uncomment to see result in png file
    //dump_png("./test_memblt2_", gd.drawable);
}

BOOST_AUTO_TEST_CASE(TestMemblt3)
{
    // Create a simple capture image and dump it to file
    uint16_t width = 320;
    uint16_t height = 200;
    Rect screen_rect(0, 0, width, height);
    BGRPalette palette;

    RDPDrawable gd(width, height, 24);
    gd.draw(RDPOpaqueRect(screen_rect, 0x2F2F2F), screen_rect);

    uint8_t raw_palette[] = {
/* 0000 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 0010 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 0020 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 0030 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 0040 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 0050 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 0060 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 0070 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 0080 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 0090 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 00a0 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 00b0 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 00c0 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 00d0 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 00e0 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 00f0 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 0100 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 0110 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 0120 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 0130 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 0140 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 0150 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 0160 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 0170 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 0180 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 0190 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 01a0 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 01b0 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 01c0 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 01d0 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 01e0 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 01f0 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 0200 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 0210 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 0220 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 0230 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 0240 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 0250 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 0260 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 0270 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 0280 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 0290 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 02a0 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 02b0 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 02c0 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 02d0 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 02e0 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 02f0 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 0300 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 0310 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 0320 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 0330 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 0340 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 0350 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 0360 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 0370 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 0380 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 0390 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 03a0 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 03b0 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 03c0 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 03d0 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 03e0 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
/* 03f0 */ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // ................
    };
    uint8_t raw_bitmap[] = {
/* 0000 */ 0xc0, 0x0c, 0xb4, 0x1d, 0x84, 0xb4, 0x1d, 0xb4, 0x1d, 0xb4, 0x1d, 0xb4, 0x1d, 0xf0, 0x60, 0x01,  // ..............`.
/* 0010 */ 0xc0, 0x04, 0xed, 0x76, 0x00, 0x2e, 0xce, 0x70, 0x4e, 0x11, 0x8f, 0x08, 0x21, 0x52, 0x4a, 0x11,  // ...v...pN...!RJ.
/* 0020 */ 0x42, 0x10, 0x42, 0x10, 0x42, 0x10, 0x42, 0xf0, 0x3d, 0xf0, 0x3d, 0xef, 0x3d, 0xef, 0x3d, 0xef,  // B.B.B.B.=.=.=.=.
/* 0030 */ 0x3d, 0xef, 0x3d, 0xcf, 0x3d, 0x10, 0x42, 0x10, 0x42, 0x40, 0x31, 0x01, 0x00, 0x00, 0x00, 0x00,  // =.=.=.B.B@1.....
/* 0040 */ 0x00, 0x00, 0x8e, 0x32, 0x46, 0xef, 0x3d, 0xef, 0x3d, 0xef, 0x3d, 0xef, 0x3d, 0xef, 0x3d, 0xce,  // ...2F.=.=.=.=.=.
/* 0050 */ 0x39, 0xce, 0x39, 0xce, 0x39, 0xae, 0x39, 0xae, 0x39, 0xae, 0x39, 0xcf, 0x39, 0xcf, 0x39, 0x11,  // 9.9.9.9.9.9.9.9.
/* 0060 */ 0x83, 0x29, 0x25, 0x52, 0x4a, 0xf0, 0x3d, 0x06, 0x84, 0xcf, 0x39, 0xad, 0x35, 0xae, 0x35, 0xce,  // .)%RJ.=...9.5.5.
/* 0070 */ 0x39, 0x15, 0x8d, 0x7b, 0x6f, 0x39, 0x67, 0x11, 0x42, 0x11, 0x42, 0xcf, 0x3d, 0x9c, 0x73, 0x5a,  // 9..{o9g.B.B.=.sZ
/* 0080 */ 0x6b, 0xcf, 0x39, 0x9c, 0x73, 0x5a, 0x6b, 0xae, 0x35, 0x9c, 0x73, 0x9c, 0x73, 0x12, 0x8e, 0x94,  // k.9.sZk.5.s.s...
/* 0090 */ 0x52, 0xde, 0x7b, 0xff, 0x7f, 0xd6, 0x5a, 0xd6, 0x5a, 0xef, 0x3d, 0xff, 0x7f, 0x39, 0x67, 0xef,  // R.{...Z.Z.=..9g.
/* 00a0 */ 0x3d, 0xff, 0x7f, 0xf7, 0x5e, 0xce, 0x39, 0xff, 0x7f, 0xff, 0x7f, 0x12, 0x8e, 0x39, 0x67, 0xff,  // =...^.9......9g.
/* 00b0 */ 0x7f, 0xff, 0x7f, 0xde, 0x7b, 0xde, 0x7b, 0x52, 0x4a, 0xff, 0x7f, 0x19, 0x67, 0xef, 0x3d, 0xff,  // ....{.{RJ...g.=.
/* 00c0 */ 0x7f, 0xf7, 0x5e, 0xae, 0x39, 0xde, 0x7b, 0xde, 0x7b, 0x12, 0x8e, 0xff, 0x7f, 0xbe, 0x77, 0x94,  // ..^.9.{.{.....w.
/* 00d0 */ 0x52, 0xff, 0x7f, 0xff, 0x7f, 0x9c, 0x73, 0xff, 0x7f, 0x39, 0x67, 0x10, 0x42, 0xff, 0x7f, 0x18,  // R.....s..9g.B...
/* 00e0 */ 0x63, 0xcf, 0x39, 0xff, 0x7f, 0xff, 0x7f, 0x13, 0x84, 0xd6, 0x5a, 0x11, 0x42, 0x7b, 0x6f, 0x7b,  // c.9.......Z.B{o{
/* 00f0 */ 0x6f, 0x69, 0xff, 0x7f, 0x12, 0x8c, 0x7b, 0x6f, 0x74, 0x4e, 0x52, 0x4a, 0x94, 0x4e, 0x94, 0x4e,  // oi....{otNRJ.N.N
/* 0100 */ 0xbd, 0x77, 0xf7, 0x5e, 0x94, 0x52, 0x9d, 0x73, 0xd6, 0x5a, 0x73, 0x4e, 0x9c, 0x73, 0xd0, 0x33,  // .w.^.R.s.ZsN.s.3
/* 0110 */ 0x08, 0x21, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x8e, 0xd6, 0x5a, 0x94, 0x52, 0x94, 0x52,  // .!.........Z.R.R
/* 0120 */ 0x73, 0x4a, 0x73, 0x4a, 0x31, 0x46, 0x31, 0x46, 0x11, 0x42, 0xf0, 0x3d, 0xf0, 0x3d, 0xf0, 0x3d,  // sJsJ1F1F.B.=.=.=
/* 0130 */ 0xce, 0x39, 0xf0, 0x3d, 0xf0, 0x3d, 0x12, 0x8e, 0x18, 0x63, 0xb5, 0x52, 0x94, 0x52, 0x74, 0x4e,  // .9.=.=...c.R.RtN
/* 0140 */ 0x74, 0x4e, 0x73, 0x4e, 0x53, 0x4a, 0x52, 0x4a, 0x32, 0x46, 0x31, 0x46, 0x11, 0x42, 0x10, 0x42,  // tNsNSJRJ2F1F.B.B
/* 0150 */ 0x31, 0x46, 0x31, 0x46, 0x12, 0x8e, 0x9c, 0x6f, 0x18, 0x63, 0x18, 0x5f, 0xf7, 0x5e, 0xf7, 0x5e,  // 1F1F...o.c._.^.^
/* 0160 */ 0xd6, 0x5a, 0xb6, 0x56, 0xb5, 0x52, 0x94, 0x52, 0x74, 0x4e, 0x73, 0x4e, 0x53, 0x4a, 0x74, 0x4e,  // .Z.V.R.RtNsNSJtN
/* 0170 */ 0x74, 0x4e, 0x11, 0x81, 0x59, 0x6b, 0x6e, 0x29, 0x25, 0x81, 0x59, 0x6b, 0x11, 0x72, 0x59, 0x6b,  // tN..Ykn)%.Yk.rYk
/* 0180 */ 0x08, 0x84, 0xb4, 0x1d, 0xb4, 0x1d, 0xb4, 0x1d, 0xb4, 0x1d,                    // ..........
    };

    memcpy(palette, raw_palette, sizeof(palette));

    Bitmap bmp(15, 15, &palette, 32, 32, raw_bitmap, sizeof(raw_bitmap), true);

    // red square
    gd.draw(RDPMemBlt(1, Rect(5, 5, 20, 20), 0xCC, 0, 0, 10), screen_rect, bmp);

    //char message[1024];
    //if (!check_sig(gd.drawable, message,
    //"\x98\x6c\x40\x0b\x3a\xbc\x39\x38\x29\x11\x77\x37\x98\xe2\x27\xb2\xcb\x61\xec\x5d"
    //)){
    //    BOOST_CHECK_MESSAGE(false, message);
    //}

    // uncomment to see result in png file
    //dump_png("./test_memblt3_", gd.drawable);
}
